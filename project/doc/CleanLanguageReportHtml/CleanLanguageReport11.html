<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Clean Language Report</title>
</head>
<body style="font-family:Helvetica">
<div><div style="position: absolute;"><svg width="355.555555555556" height="177.777777777778">
<path d="M49.7777777777778 7.32929319639176 h280.888888888889 v141.785858051661 h-280.888888888889 Z M64 33.9959598630584 h252.444444444444 v88.4525247183276 h-252.444444444444 Z" stroke="none" fill="#3F87AF" fill-rule="evenodd"/>
<path d="M64 111.781817914719 h252.444444444444 v10.6666666666667 h-252.444444444444 Z" stroke="none" fill="#8C96A0"/>
<path d="M64 33.9959598630584 h252.444444444444 v10.6666666666667 h-252.444444444444 Z" stroke="none" fill="#8C96A0"/>
<path d="M64 44.6626265297251 h252.444444444444 v67.1191913849942 h-252.444444444444 Z" stroke="none" fill="#FFFFFF"/>
<path d="M99.1179703874409 137.550135143052 C93.2711853763986 133.302197180425,88.084448516421 128.213312506961,83.725936053644 122.448484581386 L110.089961763567 122.448484581386 Z" stroke="none" fill="#8C96A0"/>
<path d="M99.1179703874409 18.8943093013927 C93.2711853763986 23.1422472640192,88.084448516421 28.2311319374834,83.725936053644 33.9959598630584 L110.089961763567 33.9959598630584 Z" stroke="none" fill="#8C96A0"/>
<path d="M126.968649704419 100.555210486665 C109.380820468897 87.7769045717629,109.380820468897 61.5564287615705,126.968649704419 48.7781228466684 L116.780371998016 34.7551616108359 C89.6658019265873 54.45504989631,89.6658019265873 94.8782834370233,116.780371998016 114.578171722497 Z" stroke="none" fill="#8C96A0"/>
<path d="M113.645517319123 118.89292902583 C83.5996423751073 97.0633230878727,83.5996423751073 52.2700102454607,113.645517319123 30.4404043075029 L102.673525942996 15.3387537458372 C62.3680839449271 44.6223714674879,62.3680839449271 104.710961865845,102.673525942996 133.994579587496 Z" stroke="none" fill="#8C96A0"/>
<path d="M123.413094148863 104.110766042221 C105.825264913342 91.3324601273184,105.825264913342 65.111984317126,123.413094148863 52.3336784022239 L113.22481644246 38.3107171663915 C86.1102463710318 58.0106054518656,86.1102463710318 98.4338389925788,113.22481644246 118.133727278053  Z" stroke="none" fill="#3F87AF"/>
<path d="M110.089961763567 122.448484581386 C80.0440868195518 100.618878643428,80.0440868195518 55.8255658010162,110.089961763567 33.9959598630584L83.725936053644 33.9959598630584 C63.9432065006372 60.1617750913602,63.9432065006372 96.2826693530842,83.725936053644 122.448484581386" stroke="none" fill="#3F87AF"/>
<text font-family="Helvetica" font-weight="bold" font-size="56.8888888888889px" x="145.777777777778" y="103.111111111111" fill="#8C96A0">Clean</text>
<text font-family="Helvetica" font-weight="bold" font-size="56.8888888888889px" x="144.888888888889" y="102.222222222222" fill="#8C96A0">Clean</text>
<text font-family="Helvetica" font-weight="bold" font-size="56.8888888888889px" x="144" y="101.333333333333" fill="#8C96A0">Clean</text>
<text font-family="Helvetica" font-weight="bold" font-size="56.8888888888889px" x="143.111111111111" y="100.444444444444" fill="#8C96A0">Clean</text>
<text font-family="Helvetica" font-weight="bold" font-size="56.8888888888889px" x="142.222222222222" y="99.5555555555556" fill="#3F87AF">Clean</text>
</svg>
</div><h1 style="text-align:right;background-color:#9999FF;"><a id="_11"><br>Chapter 11<br><br>Foreign Language Interface</a></h1></div>
<p style="text-align:justify;">The tool htoclean can be used to generate interfaces to C functions. This is not discussed in this manual.</p>
<p style="text-align:justify;">How to call Clean functions from C is discussed in <span style="color:blue;"><a href="#_11.1">section 11.1</a></span>.</p>
<p style="text-align:justify;">ABC instructions of the virtual machine for Clean can be used. This is explained in <span style="color:blue;"><a href="#_11.2">section 11.2</a></span>.</p>
<h2 style="background-color:#9999FF;"><a id="_11.1">11.1 Foreign Export</a></h2>
<p style="text-align:justify;">Some Clean functions can be called from C using foreign export. This is possible if:</p>
<table style="border-spacing:0;width:100%;"><tr><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">The function is exported.</td></tr><tr><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">All arguments are annotated as being strict (<span style="color:blue;"><a href="CleanLanguageReport3.html#_3.7.5">see 3.7.5</a></span>).</td></tr><tr><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">The arguments and result type is either of the following:</td></tr></table>
<table style="width:100%;"><tr><td style="vertical-align:top;width:30px;"></td><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">Int</td></tr>
<tr><td style="vertical-align:top;width:30px;"></td><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">Real</td></tr>
<tr><td style="vertical-align:top;width:30px;"></td><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">{#Char}</td></tr>
<tr><td style="vertical-align:top;width:30px;"></td><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">{#Int}</td></tr>
<tr><td style="vertical-align:top;width:30px;"></td><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">{#Real}</td></tr>
<tr><td style="vertical-align:top;width:30px;"></td><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">A tuple of these strictly annotated types (including tuples).</td></tr>
</table><p style="text-align:justify;">The following syntax is used in an implementation module to export a function to a foreign language:</p>
<table style="background-color:#FFCC99;width:100%;" cellspacing="0" cellpadding="0"><tr><td style="width:23.0290909090909%;padding:0 0 4px 0;">ForeignExportDef</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">=</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;"><span style="font-family:courier;color:#FF0000;"><b>foreign export</b></span> [ <span style="font-family:courier;color:#FF0000;"><b>ccall</b></span> | <span style="font-family:courier;color:#FF0000;"><b>stdcall</b></span> ] <span style="font-family:courier;">FunctionName</span> <span style="font-family:courier;color:#0000FF;"><b>;</b></span></td></tr>
</table><p></p>
<p style="text-align:justify;">The calling convention may be specified by prefixing the function name with ccall or stdcall. The default is ccall.</p>
<p style="text-align:justify;">To pass an argument from C of type:</p>
<table style="border-spacing:0;width:100%;"><tr><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">Int, use a C integer type that has the same size as an Int in Clean. On 32 bit platforms this is 4 bytes, on 64 bit platforms 8 bytes. Usually long has the right size, except on 64 bit Windows __int64 can be used instead.</td></tr><tr><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">Real, use type double.</td></tr><tr><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">{#Char}, pass the address of the string. The first 4 (on 32 bit platforms) or 8 (on 64 bit platforms) bytes should contain the number of characters. The characters of the string are stored in the following bytes. The string is copied to the heap of Clean, and this copy is used in Clean.</td></tr><tr><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">{#Int}, pass the address of the array. The elements of the array have the same size as an Int in Clean. The number of elements should be stored in 4 bytes at offset -8 (32 bit) or 8 bytes at offset -16 (64 bit). The array is copied to the heap of Clean, and this copy is used in Clean.</td></tr><tr><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">{#Real}, pass the address of the array. The elements of the array have the same size as a Real in Clean (8 bytes) and a double in C. The number of elements should be stored in the same way as for {#Int}. The array is copied to the heap of Clean, and this copy is used in Clean.</td></tr><tr><td style="vertical-align:top;width:30px;">&bull;</td><td style="text-align:justify;">Tuple. The elements are passed as separate arguments as described above, in the same order as in the tuple.</td></tr></table>
<p style="text-align:justify;">Preferably, the macros in the file Clean.h (part of the tool htoclean) should be used to access strings and arrays.</p>
<p style="text-align:justify;">If result of the function is not a tuple, the result is passed in the same way as an argument, except that strings and arrays are not copied. The address of the string or array in the heap of Clean is passed to C. This string or array may only be used until the next call or return to Clean, because the Clean runtime system may deallocate or move the array.</p>
<p style="text-align:justify;">If multiple values are yielded, because the result is a tuple, the result type in C is void. To return the values, for each value an additional argument with the address where the result should be stored is added (at the end, in the same order as in the tuple). For example, if the result has type (Real, Int), an additional double * and long * (__int64 * for 64 bit Windows) is added.</p>
<h2 style="background-color:#9999FF;"><a id="_11.2">11.2 Using ABC instructions</a></h2>
<p style="text-align:justify;">Function can be implemented using ABC instructions from the virtual machine used by Clean:</p>
<table style="background-color:#FFCC99;width:100%;" cellspacing="0" cellpadding="0"><tr><td style="width:23.0290909090909%;padding:0 0 4px 0;">ABCCodeFunctionDef</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">=</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;">Function {Pattern} <span style="font-family:courier;color:#993300;"><b>=</b></span> <span style="font-family:courier;color:#FF0000;"><b>code</b></span> [<span style="font-family:courier;color:#FF0000;"><b>inline</b></span>] <span style="font-family:courier;color:#0000FF;"><b>{</b></span> ABCInstructions <span style="font-family:courier;color:#0000FF;"><b>}</b></span></td></tr>
</table><p></p>
<p style="text-align:justify;">By adding <span style="font-family:courier;color:#FF0000;"><b>inline</b></span> the ABC instructions will be inlined if the function is called in a strict context.</p>
<p style="text-align:justify;">This is used to define primitive functions of the StdEnv, for example integer addition. htoclean generates calls to C functions using the ABC instruction ccall.</p>
</body>
</html>
