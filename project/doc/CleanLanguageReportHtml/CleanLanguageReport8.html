<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Clean Language Report</title>
</head>
<body style="font-family:Helvetica">
<div><div style="position: absolute;"><svg width="355.555555555556" height="177.777777777778">
<path d="M49.7777777777778 7.32929319639176 h280.888888888889 v141.785858051661 h-280.888888888889 Z M64 33.9959598630584 h252.444444444444 v88.4525247183276 h-252.444444444444 Z" stroke="none" fill="#3F87AF" fill-rule="evenodd"/>
<path d="M64 111.781817914719 h252.444444444444 v10.6666666666667 h-252.444444444444 Z" stroke="none" fill="#8C96A0"/>
<path d="M64 33.9959598630584 h252.444444444444 v10.6666666666667 h-252.444444444444 Z" stroke="none" fill="#8C96A0"/>
<path d="M64 44.6626265297251 h252.444444444444 v67.1191913849942 h-252.444444444444 Z" stroke="none" fill="#FFFFFF"/>
<path d="M99.1179703874409 137.550135143052 C93.2711853763986 133.302197180425,88.084448516421 128.213312506961,83.725936053644 122.448484581386 L110.089961763567 122.448484581386 Z" stroke="none" fill="#8C96A0"/>
<path d="M99.1179703874409 18.8943093013927 C93.2711853763986 23.1422472640192,88.084448516421 28.2311319374834,83.725936053644 33.9959598630584 L110.089961763567 33.9959598630584 Z" stroke="none" fill="#8C96A0"/>
<path d="M126.968649704419 100.555210486665 C109.380820468897 87.7769045717629,109.380820468897 61.5564287615705,126.968649704419 48.7781228466684 L116.780371998016 34.7551616108359 C89.6658019265873 54.45504989631,89.6658019265873 94.8782834370233,116.780371998016 114.578171722497 Z" stroke="none" fill="#8C96A0"/>
<path d="M113.645517319123 118.89292902583 C83.5996423751073 97.0633230878727,83.5996423751073 52.2700102454607,113.645517319123 30.4404043075029 L102.673525942996 15.3387537458372 C62.3680839449271 44.6223714674879,62.3680839449271 104.710961865845,102.673525942996 133.994579587496 Z" stroke="none" fill="#8C96A0"/>
<path d="M123.413094148863 104.110766042221 C105.825264913342 91.3324601273184,105.825264913342 65.111984317126,123.413094148863 52.3336784022239 L113.22481644246 38.3107171663915 C86.1102463710318 58.0106054518656,86.1102463710318 98.4338389925788,113.22481644246 118.133727278053  Z" stroke="none" fill="#3F87AF"/>
<path d="M110.089961763567 122.448484581386 C80.0440868195518 100.618878643428,80.0440868195518 55.8255658010162,110.089961763567 33.9959598630584L83.725936053644 33.9959598630584 C63.9432065006372 60.1617750913602,63.9432065006372 96.2826693530842,83.725936053644 122.448484581386" stroke="none" fill="#3F87AF"/>
<text font-family="Helvetica" font-weight="bold" font-size="56.8888888888889px" x="145.777777777778" y="103.111111111111" fill="#8C96A0">Clean</text>
<text font-family="Helvetica" font-weight="bold" font-size="56.8888888888889px" x="144.888888888889" y="102.222222222222" fill="#8C96A0">Clean</text>
<text font-family="Helvetica" font-weight="bold" font-size="56.8888888888889px" x="144" y="101.333333333333" fill="#8C96A0">Clean</text>
<text font-family="Helvetica" font-weight="bold" font-size="56.8888888888889px" x="143.111111111111" y="100.444444444444" fill="#8C96A0">Clean</text>
<text font-family="Helvetica" font-weight="bold" font-size="56.8888888888889px" x="142.222222222222" y="99.5555555555556" fill="#3F87AF">Clean</text>
</svg>
</div><h1 style="text-align:right;background-color:#9999FF;"><a id="_8"><br>Chapter 8<br><br>Dynamics</a></h1></div>
<p style="text-align:justify;">Dynamics are a new experimental feature of CLEAN. The concept is easy to understand, but the implementation is not so straightforward (see Vervoort and Plasmeijer, 2002). So, it will take some time before all bits and pieces are implemented and the system will work flawlessly. Please be patient.</p>
<p style="text-align:justify;">What can you do with "Dynamics"? With "Dynamics" it is possible to store and exchange a CLEAN expression between (different) CLEAN applications in an easy and type-safe way. The expression may contain (unevaluated!) data and (unevaluated!) function applications. Here are some examples of its use.</p>
<table style="border-spacing:0;width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">Almost all applications <i>store and fetch information to and from disk</i> (settings and the like). Traditionally, information written to file first has to be converted by the programmer to some (<i>String</i>) format. When the file is read in again a parser has to be constructed to parse the input and to convert the <i>String</i> back to the appropriate data structure. With <span style="font-family:courier;">Dynamic</span>s one can store and retrieve (almost) any CLEAN data structure in a type-safe way with just one (!) function call. Not only data can be saved, but also code (unevaluated functions, higher order functions), which is part of the data structure being stored. <span style="font-family:courier;">Dynamic</span>s make it easier to write a <i>persistent application</i>: an application that stores the settings in such a way that the next time the user will see everything in the same way as the last time the application was used.</td></tr>
<tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">Different independently programmed CLEAN applications, even applications <i>distributed</i> across a network, can easily <i>communicate arbitrary expressions</i> that can contain data as well as code (unevaluated functions) in a type-safe way. <span style="font-family:courier;">Dynamic</span>s can be communicated via files or via message passing primitives offered by the CLEAN libraries. The fact that CLEAN applications can communicate code means that a running CLEAN application can be extended with additional functionality. So, <i>plug-ins</i> and <i>mobile code</i> can be realized very easily and everything is <i>type-safe</i>.</td></tr>
</table>
<p style="text-align:justify;">To make all this possible we need some special facilities in the CLEAN language. But, in the CLEAN run-time system special support is needed as well. This includes <i>dynamic type checking</i>, <i>dynamic type unification</i>, dynamic encoding and <i>decoding</i> of arbitrary CLEAN <i>expressions and types</i>, <i>dynamic linking</i>, <i>garbage collection</i> of dynamics objects on disk, and <i>just-in-time code generation</i>.</p>
<p style="text-align:justify;">In CLEAN 2.0 we have added a <i>dynamic type system</i> such that CLEAN now offers a <i>hybrid type system</i> with both <i>static</i> as well as <i>dynamic typing</i>. An object (expression) of static type can be packed into an object of dynamic type (a "<span style="font-family:courier;">Dynamic</span>") and backwards. The type of a Dynamic can only be checked at run-time. An application can also check whether types of several Dynamics can be unified with each other, without a need to know what types are exactly stored into a Dynamic. In this way CLEAN applications can be used as control language to manage processes and plug-ins (see Van Weelden and Plasmeijer, 2002).</p>
<p style="text-align:justify;">In this Chapter we first explain how a Dynamic can be constructed (<span style="color:blue;"><a href="#_8.1">see 8.1</a></span>). In <span style="color:blue;"><a href="#_8.2">Section 8.2</a></span> we explain how the type of a <span style="font-family:courier;">Dynamic</span> can be inspected via a pattern match, and how one can ensure that <span style="font-family:courier;">Dynamics</span> fit together by using run-time type unification.</p>
<p style="text-align:justify;">We explain in <span style="color:blue;"><a href="#_8.3">Section 8.3</a></span> how dynamics can be used to realize type safe communication of expressions between independently executing applications. In Section 8.4 we explain the basic architecture of the CLEAN run-time system that makes this all possible. Semantic restrictions and restrictions of the current implementation are summarized in <span style="color:blue;"><a href="#_8.5">Section 8.5</a></span>.</p>
<h2 style="background-color:#9999FF;"><a id="_8.1">8.1 Packing Expressions into a Dynamic</a></h2>
<p style="text-align:justify;">Since CLEAN is a strongly typed language (<span style="color:blue;"><a href="CleanLanguageReport5.html#_5">see Chapter 5</a></span>), <i>every</i> expression in CLEAN has a <i>static type</i> determined at <i>compile time</i>. The CLEAN compiler is in general able to infer the static type of any expression or any function.</p>
<p></p><div style="background-color:#FFFF45;">Example of CLEAN expressions and their static type:</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
3::Int<br>
map::(a&nbsp;-&gt;&nbsp;b)&nbsp;[a]&nbsp;-&gt;&nbsp;[b]<br>
map&nbsp;((+)&nbsp;1)::[Int]&nbsp;-&gt;[Int]<br>
MoveColorPoint&nbsp;Green::(Real,Real)&nbsp;-&gt;&nbsp;ColorPoint<br></div>
<p></p><p style="text-align:justify;">By using the keyword <span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span> one can (in principle) change <i>any</i>expression of static type <span style="font-family:courier;">:: &tau;</span> into a dynamically typed object of static type <span style="font-family:courier;">::Dynamic</span>. Such a "dynamic" is an object (a record to be precise) that contains the original expression as well as an encoding of the original static type of the expression. Both the expression as well as the encoding of its static type, are packed into a dynamic. At run-time, the contents of a dynamic (the value of the expression as well the encoded type) can be inspected via a dynamic pattern match (<span style="color:blue;"><a href="#_8.2">see 8.2</a></span>).</p>
<table style="background-color:#FFCC99;width:100%;" cellspacing="0" cellpadding="0"><tr><td style="width:23.0290909090909%;padding:0 0 4px 0;">DynamicExpression</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">=</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;"><span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span> GraphExpr [<span style="font-family:courier;color:#993300;"><b>::</b></span> [UnivQuantVariables] Type [ClassContext]]</td></tr>
</table><p></p>
<p></p><div style="background-color:#FFFF45;">Example showing how one can pack an expression into a <span style="font-family:courier;">Dynamic</span>. Optionally, the static type of the expression one wants to pack into a Dynamic can be specified.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;3<br>
<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;3::Int<br>
<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;map::A.a&nbsp;b:(a-&gt;b)&nbsp;[a]&nbsp;-&gt;&nbsp;[b]<br>
<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;map::(Int&nbsp;-&gt;&nbsp;Real)&nbsp;[Int]&nbsp;-&gt;&nbsp;[Real]<br>
<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;map&nbsp;((+)&nbsp;1)<br>
<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;MoveColorPoint&nbsp;Green<br></div>
<p></p><p></p><div style="background-color:#FFFF45;">Example of a (constant) function creating a dynamic containing an expression of type <span style="font-family:courier;">Tree Int</span>.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
::&nbsp;Tree&nbsp;a&nbsp;=&nbsp;Node&nbsp;a&nbsp;(Tree&nbsp;a)&nbsp;(Tree&nbsp;a)&nbsp;|&nbsp;Leaf<br>
<br>
MyTree::Dynamic<br>
MyTree&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;(DoubleTree&nbsp;1&nbsp;mytree)<br>
<span style="font-family:courier;color:#FF0000;"><b>where</b></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;Doubletree&nbsp;rootvalue&nbsp;tree&nbsp;=&nbsp;Node&nbsp;rootvalue&nbsp;tree&nbsp;tree<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mytree&nbsp;=&nbsp;(Node&nbsp;2&nbsp;(Node&nbsp;3&nbsp;Leaf&nbsp;Leaf)&nbsp;Leaf)<br></div>
<p></p><p style="text-align:justify;">Only the compiler is able to combine an expression with its type into a dynamic, such that it is guaranteed that the encoded type is indeed the type of the corresponding packed expression. However, as usual it is allowed to specify a more specific type than the one the compiler would infer. The compiler will check the correctness of such a (restricted) type specification. Polymorphic types can be stored as well.</p>
<p></p><table style="width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">If an expression of polymorphic type is packed into a dynamic one needs to explicitly specify the universal quantifiers as well (see the example above).</td></tr>
</table>
<p style="text-align:justify;">In principle (there are a few exceptions), any algebraic data type can be packed into a dynamic, including basic types, function types, user defined types, polymorphic types, record types, all types of arrays, all types of lists, and existentially quantified types. The system can deal with synonym types as well. Restrictions hold for packing abstract data types, uniqueness types and overloaded functions, see the sub-sections below.</p>
<p style="text-align:justify;">The static type of the object created with the keyword "dynamic" is the predefined type <span style="font-family:courier;">Dynamic</span>. Since all objects created in this way are of type <span style="font-family:courier;">Dynamic</span>, the compiler is in general not able anymore to determine the static type hidden in the <span style="font-family:courier;">Dynamic</span> and it cannot check its type consistency anymore. The type stored into a <span style="font-family:courier;">Dynamic</span> has to be checked at run-time (<span style="color:blue;"><a href="#_8.2">see 8.2</a></span> and <span style="color:blue;"><a href="#_8.3">8.3</a></span>).</p>
<h3 style="background-color:#9999FF;"><a id="_8.1.1">8.1.1 Packing Abstract Data Types</a></h3>
<p style="text-align:justify;">Certain types simply cannot be packed into a <span style="font-family:courier;">Dynamic</span> for fundamental reasons. Examples are objects of abstract predefined type that have a special meaning in the real world, such as objects of type <span style="font-family:courier;">World</span> and of type <span style="font-family:courier;">File</span>. It is not sound to pack objects of these types into a Dynamic, because their real world counterpart cannot be packed and stored.</p>
<p></p><table style="width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">Abstract data types that have a meaning in the real world (such as World, File) cannot be packed into Dynamic.</td></tr>
</table>
<p style="text-align:justify;">A compile time error message will be given in those cases were the  compiler refuses to pack an expression into a <span style="font-family:courier;">Dynamic</span>.</p>
<p style="text-align:justify;">In the current implementation there are additional restrictions on the kind of types that can be packed into a<span style="font-family:courier;">Dynamic</span>. Currently it is not possible to pack any abstract data type into a dynamic at all. The reason is that the test on equality of abstract types is not easy: it does not seem to be enough to test the equality of the definitions of the types involved. We should also test whether the operations defined on these abstract data types are exactly the same. The most straightforward way to do this would be to require that abstract data types  are coming from the same module (repository).</p>
<p></p><table style="width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">Expressions containing objects of abstract data type cannot be packed into a Dynamic. We are working on this. Check the latest version of the <span style="font-family:courier;">Clean</span> system.</td></tr>
</table>
<h3 style="background-color:#9999FF;"><a id="_8.1.2">8.1.2 Packing Overloaded Functions</a></h3>
<p style="text-align:justify;">Overloaded functions can also be packed into a <span style="font-family:courier;">Dynamic</span>. In that case the corresponding type classes (<span style="color:blue;"><a href="CleanLanguageReport6.html#_6.1">see 6.1</a></span>) are packed as additional dictionary argument of the function into the <span style="font-family:courier;">Dynamic</span>. When the <span style="font-family:courier;">Dynamic</span> is unpacked in a pattern match, the same type classes have to be defined in the receiving function, otherwise the pattern match will fail (<span style="color:blue;"><a href="#_8.2.2">see 8.2.2</a></span>).</p>
<p></p><div style="background-color:#FFFF45;">Example: storing an overloaded function into a <span style="font-family:courier;">Dynamic</span>.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
OverloadedDynamic::&nbsp;Dynamic<br>
OverloadedDynamic&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;plus&nbsp;::&nbsp;A.a:a&nbsp;a&nbsp;-&gt;&nbsp;a&nbsp;|&nbsp;+&nbsp;a<br>
<span style="font-family:courier;color:#FF0000;"><b>where</b></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;plus::&nbsp;a&nbsp;a&nbsp;-&gt;&nbsp;a&nbsp;|&nbsp;+&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;plus&nbsp;x&nbsp;y&nbsp;=&nbsp;x&nbsp;+&nbsp;y<br></div>
<p></p><p style="text-align:justify;">Currently, when an overloaded function is packed into a dynamic, one explicitly has to specify the type, including the forall quantifier and the class context.</p>
<h3 style="background-color:#9999FF;"><a id="_8.1.3">8.1.3 Packing Expressions of Unique Type</a></h3>
<p style="text-align:justify;">Expressions of unique type (<span style="color:blue;"><a href="CleanLanguageReport9.html#_9">see Chapter 9</a></span>) can also be packed into a Dynamic. However, the run-time system cannot deal with uniqueness type variables or with coercion statements (attribute variable inequalities). One can only use the type attribute "<span style="font-family:courier;">*</span>". Furthermore, one has to explicitly define the desired unicity in the type of the expression to be packed into a <span style="font-family:courier;">Dynamic</span>. Otherwise the unicity properties of the packed expression will not be stored. As usual, the compiler will check whether the specified type (including the uniqueness type attributes) of the packed expression is correct.</p>
<p></p><div style="background-color:#FFFF45;">Example: packing a function into a <span style="font-family:courier;">Dynamic</span> that can write a character to a unique file.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
MyDynamic::&nbsp;Dynamic<br>
MyDynamic&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;fwritec&nbsp;::&nbsp;Char&nbsp;*File&nbsp;-&gt;&nbsp;*File<br></div>
<p></p><table style="border-spacing:0;width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">Uniqueness type variables and coercion statements cannot be part of a type packed into a Dynamic.</td></tr>
<tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">Uniqueness type attributes are only taken into account if they are explicitly specified in the type of the packed dynamic.</td></tr>
</table>
<p></p><div style="background-color:#FFFF45;">Counter Example: <span style="font-family:courier;">Dynamics</span> cannot deal with uniqueness type variables or with attribute variable inequalities.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
MyDynamic::&nbsp;Dynamic<br>
MyDynamic&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;append&nbsp;::&nbsp;[.a]&nbsp;u:[.a]&nbsp;-&gt;&nbsp;v:[.a]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;[u&lt;=v]<br></div>
<p></p><h3 style="background-color:#9999FF;"><a id="_8.1.4">8.1.4 Packing Arguments of Unknown Type</a></h3>
<p style="text-align:justify;">The compiler is not in all cases capable to infer the concrete type to be assigned to a <span style="font-family:courier;">Dynamic</span>. For instance, when a polymorphic function is defined it is in general unknown what the type of the actual argument will be. If it is polymorphic, it can be of any type.</p>
<p></p><table style="width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">An argument of polymorphic type cannot be packed into a Dynamic.</td></tr>
</table>
<p></p><div style="background-color:#FFFF45;">Counter Example of a function creating a <span style="font-family:courier;">Dynamic</span>. Arguments of polymorphic type cannot be packed into a Dynamic.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
WrongCreateDynamic::&nbsp;t&nbsp;-&gt;&nbsp;Dynamic<br>
WrongCreateDynamic&nbsp;any&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;any<br></div>
<p></p><p style="text-align:justify;">If one wants to define a function that can wrap an arbitrary argument into a <span style="font-family:courier;">Dynamic</span>, not only the value, but also the concrete static type of that argument has to be passed to the function. For efficiency reasons, we of course do not want to pass the types of all arguments to all functions. Therefore, we have to know which of the arguments might be packed into a <span style="font-family:courier;">Dynamic</span>. A special class context restriction is used to express this. So, instead of a <i>polymorphic</i> function one has to define an <i>overloaded</i> function (<span style="color:blue;"><a href="CleanLanguageReport6.html#_6">see Chapter 6</a></span>). The class <span style="font-family:courier;">TC</span> (for <span style="font-family:courier;">T</span>ype <span style="font-family:courier;">C</span>ode) is predefined and an instance of this class is required whenever an argument of unknown type is packed into a dynamic. The compiler will automatically generate an appropriate instance of the TC when needed.</p>
<p></p><div style="background-color:#FFFF45;">Example of an overloaded function that can wrap an argument of arbitrary type into a <span style="font-family:courier;">Dynamic</span>.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
CreateDynamic::&nbsp;t&nbsp;-&gt;&nbsp;Dynamic&nbsp;|&nbsp;TC&nbsp;t<br>
CreateDynamic&nbsp;any&nbsp;=&nbsp;dynamic&nbsp;any<br>
<br>
MyTree::&nbsp;Dynamic<br>
MyTree&nbsp;=&nbsp;CreateDynamic&nbsp;(Node&nbsp;2&nbsp;(Node&nbsp;3&nbsp;Leaf&nbsp;Leaf)&nbsp;Leaf)<br></div>
<p></p><h3 style="background-color:#9999FF;"><a id="_8.1.5">8.1.5 Using Dynamic Typing to Defeat the Static Type System</a></h3>
<p style="text-align:justify;">Dynamic typing can also be used to do things the static type system would forbid. For instance, lists require that all lists elements are of the same type. Since all dynamic expressions are of type <span style="font-family:courier;">Dynamic</span>, one can combine objects of static different type into a list by turning them into a <span style="font-family:courier;">Dynamic</span>.</p>
<p></p><div style="background-color:#FFFF45;">Example: three ways to pack objects of different type into a list. The first method is to define a new type in which all types one likes to pack into a list are summarized with an appropriate constructor to distinguish them. For unpacking one can make a case distinction on the different constructors in a pattern match. Everything is nice statically typed but one can only pack and unpack the types that are mentioned in the wrapper type.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
::&nbsp;WrapperType&nbsp;=&nbsp;I&nbsp;Int&nbsp;|&nbsp;R&nbsp;Real&nbsp;|&nbsp;C&nbsp;Char<br>
<br>
MyWrapperList&nbsp;=&nbsp;[I&nbsp;1,&nbsp;R&nbsp;3.14,&nbsp;C&nbsp;'a']<br></div>
<p></p><p></p><div style="background-color:#FFFF45;">The next way to pack objects of different types is by defining a list structure using an existential type (<span style="color:blue;"><a href="CleanLanguageReport5.html#_5.1.3">see 5.1.3</a></span>). Any type can be packed now but the disadvantage is that there is no simple way to distinguish the elements and unpack them once they are packed.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
::&nbsp;ExstList&nbsp;=&nbsp;E.a:&nbsp;Cons&nbsp;a&nbsp;ExstList&nbsp;|&nbsp;Nil<br>
<br>
MyExstList&nbsp;=&nbsp;Cons&nbsp;1&nbsp;(Cons&nbsp;3.14&nbsp;(Cons&nbsp;'a'&nbsp;Nil)<br></div>
<p></p><p></p><div style="background-color:#FFFF45;">The third way is to wrap the values into a Dynamic. Any type can be packed and via a pattern match one can unwrap them as well. It is very inefficient though and one can only unwrap a value by explicitly naming the type in the pattern match (<span style="color:blue;"><a href="#_8.2">see 8.2</a></span>).</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
MyDynamicList&nbsp;=&nbsp;[<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;1,&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;3.14,&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;'a']<br></div>
<p></p><p style="text-align:justify;">It is possible to write CLEAN programs in which all arguments are dynamically typed. You can do it, but it is not a good thing to do: programs with dynamics are less reliable (run-time type errors might occur) and much more inefficient. <span style="font-family:courier;">Dynamics</span> should be used for the purpose they are designed for: type-safe storage, retrieval, and communication of arbitrary expressions between (independent) applications.</p>
<h2 style="background-color:#9999FF;"><a id="_8.2">8.2 Unpacking Dynamics Using a Dynamic Pattern Match</a></h2>
<p style="text-align:justify;">When a <span style="font-family:courier;">Dynamic</span> is created (see above), its static type is the type <span style="font-family:courier;">Dynamic</span>. The compiler is in general not able anymore to determine what the original type was of the expression that is packed into a <span style="font-family:courier;">Dynamic</span>. The only way to figure that out is at run-time (that why it is called a <span style="font-family:courier;">Dynamic</span>), by inspecting the dynamic via a pattern match (<span style="color:blue;"><a href="CleanLanguageReport3.html#_3.2">see 3.2</a></span>) or a case construct (<span style="color:blue;"><a href="CleanLanguageReport3.html#_3.4.2">see 3.4.2</a></span>). With a pattern match on a Dynamic one cannot only inspect the <i>value</i> of the expression that was packed into a <span style="font-family:courier;">Dynamic</span>, but also its original <i>type</i>. So, with <span style="font-family:courier;">Dynamics</span> run-time type checking and dynamic type unification is possible in CLEAN with all the advantages (more expressions can be typed) and disadvantages (type checking may fail at run-time) of a dynamic type system. The programmer has to take care of handling the case in which the pattern match fails due to a non-matching dynamic type.</p>
<table style="background-color:#FFCC99;width:100%;" cellspacing="0" cellpadding="0"><tr><td style="width:23.0290909090909%;padding:0 0 4px 0;">DynamicPattern</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">=</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;"><span style="font-family:courier;color:#993300;"><b>(</b></span>GraphPattern <span style="font-family:courier;color:#993300;"><b>::</b></span> DynamicType<span style="font-family:courier;color:#993300;"><b>)</b></span></td></tr>
<tr><td style="width:23.0290909090909%;padding:0 0 4px 0;">DynamicType</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">=</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;">[UnivQuantVariables] {DynPatternType}+ [ClassContext]</td></tr>
<tr><td style="width:23.0290909090909%;padding:0 0 4px 0;">DynPatternType</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">=</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;">Type</td></tr>
<tr><td style="width:23.0290909090909%;padding:0 0 4px 0;"></td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">|</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;">TypePatternVariable</td></tr>
<tr><td style="width:23.0290909090909%;padding:0 0 4px 0;"></td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">|</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;">OverloadedTypePatternVariable</td></tr>
<tr><td style="width:23.0290909090909%;padding:0 0 4px 0;">TypePatternVariable</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">=</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;">Variable</td></tr>
<tr><td style="width:23.0290909090909%;padding:0 0 4px 0;">OverloadedTypeVariable</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">=</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;">Variable<span style="font-family:courier;color:#FF0000;"><b>^</b></span></td></tr>
</table><p></p>
<p style="text-align:justify;">Any expression that can be packed into a dynamic can also be unpacked using a dynamic pattern match. With a pattern match on <span style="font-family:courier;">Dynamic</span>s a case distinction can be made on the contents of the <span style="font-family:courier;">Dynamic</span>. If the actual <span style="font-family:courier;">Dynamic</span> matches the type <i>and</i> the value specified in the pattern, the corresponding function alternative is chosen. Since it is known in that case that the <span style="font-family:courier;">Dynamic</span> matches the specified type, this knowledge is used by the static type system: dynamics of known type can be handled as ordinary expressions in the body of the function. In this way dynamics can be converted back to ordinary statically typed expressions again. The static type checker will use the knowledge to check the type consistency in the body of the corresponding function alternative.</p>
<p></p><div style="background-color:#FFFF45;">Example: Use of a dynamic pattern match to check whether a <span style="font-family:courier;">Dynamic</span> is of a specific predefined type. The first alternative of the function transform matches if the <span style="font-family:courier;">Dynamic</span> contains the Integer of value <span style="font-family:courier;">0</span>. The second alternative is chosen if the <span style="font-family:courier;">Dynamic</span> contains any Integer (other than <span style="font-family:courier;">0</span>). The third alternative demands a function from <span style="font-family:courier;">[Int]</span> to <span style="font-family:courier;">[Int]</span>. The next alternative is chosen if the <span style="font-family:courier;">Dynamic</span> is a pair of two <span style="font-family:courier;">[Int]</span>. If none of the alternatives match, the last alternative is chosen. The program will yield an empty list in that case.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
transform&nbsp;::&nbsp;Dynamic&nbsp;-&gt;&nbsp;[Int]<br>
transform&nbsp;(0&nbsp;::&nbsp;Int)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;[]<br>
transform&nbsp;(n&nbsp;::&nbsp;Int)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;[n]<br>
transform&nbsp;(f&nbsp;::&nbsp;[Int]-&gt;[Int])&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;f&nbsp;[1..100]<br>
transform&nbsp;((x,y)&nbsp;::&nbsp;([Int],[Int]))&nbsp;=&nbsp;x&nbsp;++&nbsp;y<br>
transform&nbsp;other&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;[]<br></div>
<p></p><p style="text-align:justify;">Warning: when defining a pattern match on <span style="font-family:courier;">Dynamics</span>, one should always be aware that the pattern match might fail. So, we advise you to <i>always</i>include an alternative that can handle non-matching dynamics. The application will otherwise abort with an error message that none of the function alternatives matched.</p>
<p></p><div style="background-color:#FFFF45;">Example: use of a dynamic pattern match to check whether a <span style="font-family:courier;">Dynamic</span> is of a specific user defined algebraic data type. If the <span style="font-family:courier;">Dynamic</span> contains a <span style="font-family:courier;">Tree</span> of <span style="font-family:courier;">Int</span>, the function <span style="font-family:courier;">CountDynamicLeafs</span> will count the number of leafs in this tree. Otherwise CountDynamicLeafs  will return <span style="font-family:courier;">0</span>.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
::&nbsp;Tree&nbsp;a&nbsp;=&nbsp;Node&nbsp;a&nbsp;(Tree&nbsp;a)&nbsp;(Tree&nbsp;a)&nbsp;|&nbsp;Leaf<br>
<br>
CountDynamicLeafs&nbsp;::&nbsp;Dynamic&nbsp;-&gt;&nbsp;Int<br>
CountDynamicLeafs&nbsp;(tree&nbsp;::&nbsp;Tree&nbsp;Int)&nbsp;&nbsp;=&nbsp;countleafs&nbsp;tree<br>
CountDynamicLeafs&nbsp;other&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0<br>
<span style="font-family:courier;color:#FF0000;"><b>where</b></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;countleafs&nbsp;::&nbsp;(Tree&nbsp;Int)&nbsp;-&gt;&nbsp;Int<br>
&nbsp;&nbsp;&nbsp;&nbsp;countleafs&nbsp;&nbsp;tree&nbsp;=&nbsp;count&nbsp;tree&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:courier;color:#FF0000;"><b>where</b></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count::&nbsp;(Tree&nbsp;a)&nbsp;Int&nbsp;-&gt;&nbsp;Int<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;Leaf&nbsp;nleafs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;nleafs&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;(Node&nbsp;left&nbsp;right)&nbsp;nleafs&nbsp;=&nbsp;count&nbsp;left&nbsp;(count&nbsp;right&nbsp;nleafs)<br>
<br>
MyTree&nbsp;::&nbsp;Dynamic<br>
MyTree&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;(Node&nbsp;1&nbsp;(Node&nbsp;2&nbsp;(Node&nbsp;3&nbsp;Leaf&nbsp;Leaf)&nbsp;Leaf)&nbsp;(Node&nbsp;4&nbsp;Leaf&nbsp;Leaf))<br>
<br>
Start&nbsp;::&nbsp;Int<br>
Start&nbsp;=&nbsp;CountDynamicLeafs&nbsp;MyTree<br></div>
<p></p><p></p><div style="background-color:#FFFF45;">Example: use of a dynamic pattern match to check whether a <span style="font-family:courier;">Dynamic</span> is a polymorphic function (the identity function in this case).</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
TestId&nbsp;::&nbsp;Dynamic&nbsp;a&nbsp;-&gt;&nbsp;a<br>
TestId&nbsp;(id&nbsp;::&nbsp;A.b:&nbsp;b&nbsp;-&gt;&nbsp;b)&nbsp;x&nbsp;=&nbsp;id&nbsp;x<br>
TestId&nbsp;else&nbsp;x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;x<br></div>
<p></p><table style="border-spacing:0;width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">To avoid confusion with type pattern variables (<span style="color:blue;"><a href="#_8.2.4">see 8.2.4</a></span> and <span style="color:blue;"><a href="#_8.2.5">8.2.5</a></span>), polymorphic type variables have to be explicitly introduced with the forall quantifier <span style="font-family:courier;">(A</span>.).</td></tr>
<tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">Quantifiers are only allowed on the outermost level (Rank 1).</td></tr>
</table>
<p style="text-align:justify;"><span style="font-family:courier;">Dynamic</span>s can be created by functions in other modules or even come from other (totally different) <span style="font-family:courier;">Clean</span> applications (<span style="color:blue;"><a href="#_8.3">see 8.3</a></span>). It is therefore possible that in a <span style="font-family:courier;">Dynamic</span> a type with a certain name is stored, yet this type might have a type definition which is (slightly or totally) different from the type known in the matching function. So, the context in which a dynamic is packed might be totally different from the context in which the dynamic is unpacked via a pattern match. Hence, it is not enough that matching type constructors have identical names; they should also have exactly the same type definition. If not, the match will fail.</p>
<p style="text-align:justify;"><i>Two types are considered to be equal if and only if all the type definitions (type constructors, data constructors, class definitions) are syntactically identical modulo the names of type variables (alpha conversion is allowed). Type equivalence of type constructors is automatically checked by the </i><span style="font-family:courier;">Clean</span> run-time system, even if these types are defined in totally different <span style="font-family:courier;">Clean</span> applications. To make this possible, we had to change the architecture of the <span style="font-family:courier;">Clean</span> run-time system (<span style="color:blue;"><a href="#_8.4">see 8.4</a></span>).</p>
<p style="text-align:justify;">So, when a pattern match on a dynamic takes place, the following things are checked in the indicated order (case constructs are handled in a similar way):</p>
<table style="width:100%;"><tr><td style="vertical-align:top;width:30px;">1)</td><td style="text-align:justify;">All the type constructors (either of basic type, predefined or user defined) specified in a dynamic pattern will be compared with the name of the corresponding actual type constructors stored in the dynamics. If corresponding type constructors have different names, the pattern match fails and the next alternative is tried.</td></tr></table>
<table style="width:100%;"><tr><td style="vertical-align:top;width:30px;">2)</td><td style="text-align:justify;">If in the pattern match, corresponding type's constructors have the same name, the run-time system will check whether their type definitions (their type might have been defined in different <span style="font-family:courier;">Clean</span> applications or different <span style="font-family:courier;">Clean</span> modules) are the same as well. The system knows where to find these type definitions (<span style="color:blue;"><a href="#_8.3">see 8.3</a></span> and <span style="color:blue;"><a href="#_8.4">8.4</a></span>). If the definitions are not the same, the types are considered to be different. The pattern match fails and the next alternative is tried.</td></tr></table>
<table style="width:100%;"><tr><td style="vertical-align:top;width:30px;">3)</td><td style="text-align:justify;">If the types are the same, the actual data constructors (constant values) are compared with the data constructors specified in the patterns, as usual in a standard pattern match (<span style="color:blue;"><a href="CleanLanguageReport3.html#_3.2">see 3.2</a></span>) without dynamics. If all the specified constants match the actual values, the match is successful and the corresponding function alternative is chosen. Otherwise, the pattern match fails and the next alternative is tried.</td></tr></table>
<p style="text-align:justify;">In the current implementation there are additional restrictions on the kind of types that can be packed into a <span style="font-family:courier;">Dynamic</span> and therefore also be unpacked from a <span style="font-family:courier;">Dynamic</span> (<span style="color:blue;"><a href="#_8.2.1">see 8.2.1</a></span>, <span style="color:blue;"><a href="#_8.2.2">8.2.2</a></span>, and <span style="color:blue;"><a href="#_8.2.3">8.2.3</a></span>).</p>
<p style="text-align:justify;">In a dynamic pattern match one can explicitly specify to match on a certain type constructors (e.g. <span style="font-family:courier;">Tree Int</span>). One can also use a type pattern variable (<span style="color:blue;"><a href="#_8.2.4">see 8.2.4</a></span>) to specify a type scheme with which the actual type has to be unified. By using overloaded variables (<span style="color:blue;"><a href="#_8.2.5">see 8.2.5</a></span>) defined in the type of the function, the static context in which a function is used can have influence on the kind of dynamic that is accepted. So, there are two special types of variables that can occur in a type pattern: type pattern variables and overloaded type pattern variables.</p>
<h3 style="background-color:#9999FF;"><a id="_8.2.1">8.2.1 Unpacking Abstract Data Types</a></h3>
<p></p><table style="width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">It is not yet possible to pack or unpack an abstract data type. <span style="color:blue;"><a href="#_8.1.1">See also 8.1.1</a></span>.</td></tr>
</table>
<h3 style="background-color:#9999FF;"><a id="_8.2.2">8.2.2 Unpacking of Overloaded Functions</a></h3>
<p style="text-align:justify;">One can specify a class restriction in the type in a dynamic pattern match. The system will check whether the actual dynamic contains a function that is indeed overloaded with exactly the same class context restriction as specified in the pattern. Two class definitions are regarded to be equal if all involved class definitions are syntactically equal, modulo alpha conversion of the type variables.</p>
<table style="border-spacing:0;width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">One is obligated for overloaded type variables to introduce them via the forall quantifier in the pattern, to avoid confusion with type pattern variables (see <span style="color:blue;"><a href="#_8.2.4">8.2.4</a></span> and <span style="color:blue;"><a href="#_8.2.5">8.2.5</a></span>).</td></tr>
<tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">Quantifiers are only allowed on the outermost level.</td></tr>
</table>
<p></p><div style="background-color:#FFFF45;">Example: Unpacking of an overloaded function. The pattern match will only be successful if the dynamic contains a function overloaded in <span style="font-family:courier;">+</span>. The corresponding class definitions will be checked: the definition of the class <span style="font-family:courier;">+</span> has to be the same as the class <span style="font-family:courier;">+</span> known in the context where the dynamic has been created. Due to the application of <span style="font-family:courier;">plus 2 3</span>, the type checker will require an instance for <span style="font-family:courier;">+</span> on integer values.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
CheckDynamic::&nbsp;Dynamic&nbsp;-&gt;&nbsp;Int<br>
CheckDynamic&nbsp;(plus&nbsp;::&nbsp;A.a&nbsp;:&nbsp;a&nbsp;a&nbsp;-&gt;&nbsp;a&nbsp;|&nbsp;+&nbsp;a)&nbsp;=&nbsp;plus&nbsp;2&nbsp;3<br>
CheckDynamic&nbsp;else&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0<br></div>
<p></p><h3 style="background-color:#9999FF;"><a id="_8.2.3">8.2.3 Unpacking Expressions of Unique Type</a></h3>
<p style="text-align:justify;">Expressions of unique type (<span style="color:blue;"><a href="CleanLanguageReport9.html#_9">see Chapter 9)</a></span> can also be unpacked via a dynamic pattern match. However, the run-time system cannot deal with uniqueness type variables or with coercion statements (attribute variable inequalities). One can only use the type attribute "<span style="font-family:courier;">*</span>". The match will only be successful if the specified types match and all type attributes also match. No coercion from unique to non-unique or the other way around will take place.</p>
<p></p><div style="background-color:#FFFF45;">Example: Unpacking a function that can write a character to a unique file.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
WriteCharDynamic::&nbsp;Dynamic&nbsp;Char&nbsp;*File&nbsp;-&gt;&nbsp;*File<br>
WriteCharDynamic&nbsp;(fwc&nbsp;::&nbsp;Char&nbsp;*File&nbsp;-&gt;&nbsp;*File)&nbsp;char&nbsp;myfile&nbsp;=&nbsp;fwc&nbsp;char&nbsp;myfile<br>
WriteCharDynamic&nbsp;else&nbsp;char&nbsp;myfile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;myfile<br></div>
<p></p><table style="border-spacing:0;width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">Uniqueness type variables and coercion statements cannot be used in a dynamic pattern match.</td></tr>
<tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">The type attributes of the formal argument and the actual argument have to be exactly the same. No coercion from unique to non-unique or the other way around will take place.</td></tr>
</table>
<h3 style="background-color:#9999FF;"><a id="_8.2.4">8.2.4 Checking and Unifying Types Schemes using Type Pattern Variables</a></h3>
<p style="text-align:justify;">In an ordinary pattern match one can use <i>data constructors</i> (to test whether an argument is of a <i>specific value</i>) and <i>variables</i> (which match on <i>any concrete value</i> in the domain). Similarly, in a pattern match on a dynamic type one can use <i>type constructors</i> (to test whether a dynamic contains an expression of a <i>specific type</i>) and <i>type pattern variables</i> (which match on <i>any type</i>). However, there are differences between ordinary variables and type pattern variables as well. All ordinary variable symbols introduced at the left-hand side of a function definition must have different names (<span style="color:blue;"><a href="CleanLanguageReport3.html#_3.2">see 3.2</a></span>). But, the same type variable symbol can be used several times in the left-hand side (and, of course, also in the right-hand side) of a function definition. Type pattern variables have the function alternative as scope and can appear in a pattern as well as in the right-hand side of a function in the context of a dynamic type.</p>
<table style="background-color:#FFCC99;width:100%;" cellspacing="0" cellpadding="0"><tr><td style="width:23.0290909090909%;padding:0 0 4px 0;">TypePatternVariable</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">=</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;">Variable</td></tr>
</table><p></p>
<p style="text-align:justify;">Each time the <i>same</i> type variable is used in the left-hand side, the pattern matching mechanism will try to <i>unify</i> the type variable with the concrete type stored in the dynamic. If the same type variable is used several times on the left hand-side, the most general unifier is determined that matches on <i>all</i> corresponding types in the dynamics. If no general unifier can be found, the match will fail. As usual, of all corresponding type constructors it will be checked whether they are indeed the same: the corresponding type definitions have to be equivalent (<span style="color:blue;"><a href="#_8.2">see 8.2</a></span>). Type equivalence of matching type constructors is automatically checked by the <span style="font-family:courier;">Clean</span> run-time system, even if these types are defined in different <span style="font-family:courier;">Clean</span> applications.</p>
<p style="text-align:justify;">Type pattern variables are very handy. They can be used to check for certain type schemes or to check the internal type consistency between different Dynamics, while the checking function does not exactly has to know which concrete types are actually stored in a dynamic. One can make use of type pattern variables to manage and control plug-ins in a flexible way see 8.3).</p>
<p></p><div style="background-color:#FFFF45;">The function <span style="font-family:courier;">dynApply</span> has two arguments of type <span style="font-family:courier;">Dynamic</span> and yields a value of type <span style="font-family:courier;">Dynamic</span> as well. The first <span style="font-family:courier;">Dynamic</span> has to contain a function unifiable with type <span style="font-family:courier;">(a -&gt; b)</span>, the second argument has to be <i>unifiable</i> with the argument type <span style="font-family:courier;">a</span> the function is expecting. In this way we can ensure that it is type technically safe to apply the function to the argument, without exactly knowing what the actual types are. The result will have the statically unknown type <span style="font-family:courier;">b</span>, but, by packing this result into a Dynamic again, the static type system is happy: it is a <span style="font-family:courier;">Dynamic</span>. If the dynamics types cannot be unified, it is not type safe to apply the function to the argument, and the next alternative of <span style="font-family:courier;">dynApply</span> is chosen. It yields an error message stored into a dynamic.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
dynApply&nbsp;::&nbsp;Dynamic&nbsp;Dynamic&nbsp;-&gt;&nbsp;Dynamic<br>
dynApply&nbsp;(f&nbsp;::&nbsp;a&nbsp;-&gt;&nbsp;b)&nbsp;(x&nbsp;::&nbsp;a)&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;(f&nbsp;x&nbsp;::&nbsp;b)<br>
dynApply&nbsp;&nbsp;df&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;("cannot&nbsp;apply&nbsp;",df,"&nbsp;to&nbsp;",dx)<br>
<br>
Start&nbsp;=&nbsp;dynApply&nbsp;(<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;(map&nbsp;((+)&nbsp;1))&nbsp;(<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;[1..10])<br></div>
<p></p><p style="text-align:justify;">Type pattern variables behave similar as existentially quantified type variables (<span style="color:blue;"><a href="CleanLanguageReport5.html#_5.1.3">see 5.1.3</a></span>). It is statically impossible to determine what the actual type of a type pattern variable is. So, in the static type system one cannot define an expression which type is depending on the value of a type pattern variable. The static type system cannot deal with it, since it does no know its value. However, an expression which type is depending on the type assigned to a type pattern variable can be packed into a dynamic again, because this is done at run-time. See the <span style="font-family:courier;">dynAppy</span> example above.</p>
<p></p><table style="width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">	It is not allowed to create an expression which static type is depending on the value of a type pattern variable.</td></tr>
</table>
<p></p><div style="background-color:#FFFF45;">Counter Example: It is not possible to let a static type depend on the value of a type pattern variable. The actual value of the type <span style="font-family:courier;">b</span> in <span style="font-family:courier;">WrongDynApply</span> is unknown at run-time. This example will result into a type error. See <span style="color:blue;"><a href="#_8.2.5">8.2.5</a></span> for a legal variant of this function.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
WrongDynApply&nbsp;::&nbsp;Dynamic&nbsp;Dynamic&nbsp;-&gt;&nbsp;???<br>
WrongDynApply&nbsp;(f&nbsp;::&nbsp;a&nbsp;-&gt;&nbsp;b)&nbsp;(x&nbsp;::&nbsp;a)&nbsp;&nbsp;=&nbsp;f&nbsp;x<br>
WrongDynApply&nbsp;df&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;abort&nbsp;"cannot&nbsp;perform&nbsp;the&nbsp;dyanmic&nbsp;application"<br>
<br>
Start&nbsp;=&nbsp;WrongDynApply&nbsp;(<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;(map&nbsp;((+)&nbsp;1))&nbsp;(<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;[1..10])&nbsp;++&nbsp;[11..99]<br></div>
<p></p><p style="text-align:justify;">Note: don't confuse type pattern variables with the other variables that can appear in a dynamic type to indicate polymorphic or overloaded functions or constructors. The latter are introduced via a quantifier in the type. <span style="color:blue;"><a href="#_8.2.5">See also 8.2.5</a></span>.</p>
<h3 style="background-color:#9999FF;"><a id="_8.2.5">8.2.5 Checking and Unifying Unknown Types using Overloaded Type Variables</a></h3>
<p style="text-align:justify;">In a dynamic pattern match one can explicitly state what type of a <span style="font-family:courier;">Dynamic</span> is demanded. But it is also possible to let the static context in which a function is used impose restrictions on the Dynamic to be accepted. This can be realized by using <i>overloaded type variables</i> in a dynamic pattern. Such an overloaded type variable has to be introduced in the type of the function itself and the variable should have the predefined type class <span style="font-family:courier;">TC</span> (<span style="color:blue;"><a href="#_8.1.1">see 8.1.1</a></span>) as context restriction. This makes it possible to let the overloading mechanism determine what the demanded type of a Dynamic has to be (the "type dependent functions" as introduced by Marco Pil, 1999). By using such an overloaded type variable in a dynamic pattern, the type assigned by the static overloading mechanism to this variable is used as specification of the required type in the dynamic pattern match. The caret symbol (<span style="font-family:courier;">^</span>) is used as suffix of a type pattern variable in a dynamic pattern match to indicate that an overloaded type variable is used, instead of a type pattern variable. Overloaded type variables have the whole function definition as scope, including the type of the function itself.</p>
<table style="background-color:#FFCC99;width:100%;" cellspacing="0" cellpadding="0"><tr><td style="width:23.0290909090909%;padding:0 0 4px 0;">OverloadedTypeVariable</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:1.06181818181818%;padding:0 0 4px 0;">=</td><td style="width:2.02020202020202%;padding:0 0 4px 0;"></td><td style="width:71.8690909090909%;padding:0 0 4px 0;">Variable<span style="font-family:courier;color:#FF0000;"><b>^</b></span></td></tr>
</table><p></p>
<table style="border-spacing:0;width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">An overloaded type pattern variable has to be introduced in the type definition of the function.</td></tr>
<tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">The predefined type class <span style="font-family:courier;">TC</span> (<span style="color:blue;"><a href="#_8.1.1">see 8.1.1</a></span>) has to be specified as context restriction on the global type pattern variable.</td></tr>
<tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">As is usual with overloading (<span style="color:blue;"><a href="CleanLanguageReport6.html#_6.6">see 6.6</a></span>), in some cases the compiler is not able to resolve overloading, e.g. due to internally ambiguously overloading.</td></tr>
</table>
<p></p><div style="background-color:#FFFF45;">Example: The function <span style="font-family:courier;">Start</span> appends <span style="font-family:courier;">[11..99]</span>to the result of <span style="font-family:courier;">FlexDynApply</span>. So, it is clear that <span style="font-family:courier;">FlexDynApply</span> will have to deliver a <span style="font-family:courier;">[Int]</span> to the function <span style="font-family:courier;">Start</span>. The additional context restriction <span style="font-family:courier;">TC b</span> turns <span style="font-family:courier;">FlexDynApply into an overloaded function in </span><span style="font-family:courier;">b</span>. The function <span style="font-family:courier;">FlexDynApply</span> will not deliver <i>some</i> dynamic type <span style="font-family:courier;">b</span>, but <i>the</i> static type <span style="font-family:courier;">b</span> that is demanded by the context applying <span style="font-family:courier;">FlexDynApply</span>. The overloading mechanism will automatically pass as additional parameter information about the static type <span style="font-family:courier;">b</span> that is required by the context. This type is then used to check the actual type of the dynamic in the dynamic pattern match</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
FlexDynApply&nbsp;::&nbsp;Dynamic&nbsp;Dynamic&nbsp;-&gt;&nbsp;b&nbsp;|&nbsp;TC&nbsp;b<br>
FlexDynApply&nbsp;(f&nbsp;::&nbsp;a&nbsp;-&gt;&nbsp;b^)&nbsp;(x&nbsp;::&nbsp;a)&nbsp;&nbsp;&nbsp;=&nbsp;f&nbsp;x<br>
FlexDynApply&nbsp;df&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;abort&nbsp;"cannot&nbsp;perform&nbsp;the&nbsp;dyanmic&nbsp;application"<br>
<br>
Start&nbsp;=&nbsp;FlexDynApply&nbsp;(<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;(map&nbsp;((+)&nbsp;1))&nbsp;(<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;[1..10])&nbsp;++&nbsp;[11..99]<br></div>
<p></p><p></p><div style="background-color:#FFFF45;">Example: The function <span style="font-family:courier;">lookup</span> will look up a value of a certain type <span style="font-family:courier;">a</span> in its lists of <span style="font-family:courier;">Dynamic</span>s. The type it will search for  depends on the context in which the function <span style="font-family:courier;">lookup</span> is used. In Start the lookup function is used twice. In the first case an integer value is demanded (due to <span style="font-family:courier;">+ 5</span>), in the second case a real value (due to <span style="font-family:courier;">+ 2.5</span>) is required. The program will be aborted if a value of the required type cannot be found in the list.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
lookup&nbsp;::&nbsp;[Dynamic]&nbsp;-&gt;&nbsp;a&nbsp;&nbsp;|&nbsp;TC&nbsp;a<br>
lookup&nbsp;[(x&nbsp;::&nbsp;a^):xs]&nbsp;=&nbsp;x<br>
lookup&nbsp;[x:xs]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lookup&nbsp;xs<br>
lookup&nbsp;[]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;abort&nbsp;"dynamic&nbsp;type&nbsp;error"<br>
<br>
Start&nbsp;=&nbsp;(lookup&nbsp;DynamicList&nbsp;+&nbsp;5,&nbsp;lookup&nbsp;DynamicList&nbsp;+&nbsp;2.5)&nbsp;&nbsp;//&nbsp;result&nbsp;will&nbsp;be&nbsp;(6,5.64)<br>
<br>
DynamicList&nbsp;=&nbsp;[<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;1,&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;3.14,&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;'a']<br></div>
<p></p><p style="text-align:justify;">Note: don't confuse overloaded type variables with type pattern variables or the other variables that can appear in a dynamic type to indicate polymorphic or overloaded functions or constructors. The latter are introduced via a quantifier in the type.</p>
<p></p><div style="background-color:#FFFF45;">Example: the following artificial example the kinds of type variables that can be used in a dynamic pattern are shown. In the first alternative a type variable <span style="font-family:courier;">a</span> is used (introduced by the forall quantifier). This alternative only matches on a polymorphic function. In the second alternative an overloaded type variable is used (indicated by <span style="font-family:courier;">a^</span>) referring to the overloaded type variable <span style="font-family:courier;">a | TC a</span> introduced in the function body. It will match on a function of the same type as the actual type of the second argument of AllSortsOfVariables. The last alternative uses type pattern variables <span style="font-family:courier;">a</span> and <span style="font-family:courier;">b</span>. It matches on any function type, although this function is not used.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
AllSortsOfVariables&nbsp;::&nbsp;Dynamic&nbsp;&nbsp;a&nbsp;-&gt;&nbsp;a&nbsp;|&nbsp;TC&nbsp;a<br>
AllSortsOfVariables&nbsp;(id::A.a&nbsp;:&nbsp;(a&nbsp;-&gt;&nbsp;a))&nbsp;x&nbsp;&nbsp;=&nbsp;id&nbsp;x<br>
AllSortsOfVariables&nbsp;(f::a^&nbsp;-&gt;&nbsp;a^)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;&nbsp;=&nbsp;f&nbsp;x<br>
AllSortsOfVariables&nbsp;(f::a&nbsp;-&gt;&nbsp;b)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x&nbsp;&nbsp;=&nbsp;x<br></div>
<p></p><h2 style="background-color:#9999FF;"><a id="_8.3">8.3 Type Safe Communication using Dynamics</a></h2>
<p style="text-align:justify;">As explained in the introduction of this Chapter, the most important practical use of <span style="font-family:courier;">Dynamic</span>s is enabling type safe communication of data and code between different (distributed) CLEAN applications. When a <span style="font-family:courier;">Dynamic</span> is stored or communicated it will be encoded (serialized) to a string. So, in principle almost any communication media can be used to communicate <span style="font-family:courier;">Dynamic</span>s. In this section we only explain how to store and retrieve a <span style="font-family:courier;">Dynamic</span> from a <span style="font-family:courier;">File</span>. It is also possible to communicate a <span style="font-family:courier;">Dynamic</span> directly via a channel or via send / receive communication primitives. The actual possibilities are depending on the facilities offered by CLEAN libraries. This is outside the scope of this CLEAN language report.</p>
<p style="text-align:justify;">If a CLEAN application stores a <span style="font-family:courier;">Dynamic</span> into a <span style="font-family:courier;">File</span> <i>any</i> other (totally different) CLEAN application can read the <span style="font-family:courier;">Dynamic</span> from it. Since a <span style="font-family:courier;">Dynamic</span> can contain data as well as code (unevaluated function applications), this means that any part of one CLEAN program can be plugged into another. Since CLEAN is using compiled code, this has a high impact on the run-time system (<span style="color:blue;"><a href="#_8.4">see 8.4</a></span>).</p>
<p style="text-align:justify;">One can read and write a <span style="font-family:courier;">Dynamic</span> with just <i>one</i> function call. In the CLEAN library <span style="font-family:courier;">StdDynamic</span> the functions <span style="font-family:courier;">readDynamic</span> and <span style="font-family:courier;">writeDynamic</span> are predefined. As usual in CLEAN, uniqueness typing is used for performing I/O (<span style="color:blue;"><a href="CleanLanguageReport9.html#_9.1">see 9.1</a></span>). When a <span style="font-family:courier;">Dynamic</span>is written, the whole expression (the graph expression and its static type) is encoded symbolically to a <span style="font-family:courier;">String</span> and stored on disk. When a <span style="font-family:courier;">Dynamic</span> is read, it is read in lazily. Only when the evaluation of the <span style="font-family:courier;">Dynamic</span> is demanded (which can only happen after a successful pattern match), the String is decoded back to a <span style="font-family:courier;">Dynamic</span>. If new function definitions have to be plugged in, this will be done automatically (<span style="color:blue;"><a href="#_8.4">see 8.4</a></span>). This lazy reading is also done for <span style="font-family:courier;">Dynamics</span> stored into a <span style="font-family:courier;">Dynamic</span>. So, a <span style="font-family:courier;">Dynamic</span> can only be plugged in if its type is approved in a <span style="font-family:courier;">Dynamic</span> pattern match.</p>
<p></p><div style="background-color:#FFFF45;">Standard functions for reading and writing of a Dynamic.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
<span style="font-family:courier;color:#FF0000;"><b>definition</b></span>&nbsp;<span style="font-family:courier;color:#FF0000;"><b>module</b></span>&nbsp;StdDynamic<br>
<br>
...<br>
<br>
writeDynamic&nbsp;::&nbsp;Dynamic&nbsp;String&nbsp;*World&nbsp;-&gt;&nbsp;*(Bool,*World)<br>
<br>
readDynamic&nbsp;::&nbsp;String&nbsp;*World&nbsp;-&gt;&nbsp;*(Bool,&nbsp;Dynamic,&nbsp;*World)<br></div>
<p></p><p style="text-align:justify;">The use of <span style="font-family:courier;">Dynamics</span> is shown in the examples below. Each example is a complete CLEAN application.</p>
<p></p><div style="background-color:#FFFF45;">Example of a CLEAN application writing a <span style="font-family:courier;">Dynamic</span> containing a value of type <span style="font-family:courier;">Tree Int</span> to a <span style="font-family:courier;">File</span> named <span style="font-family:courier;">DynTreeValue</span>. This example shows that data can be stored to disk using the CLEAN function <span style="font-family:courier;">writeDynamic</span>.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
<span style="font-family:courier;color:#FF0000;"><b>module</b></span>&nbsp;TreeValue<br>
<br>
<span style="font-family:courier;color:#FF0000;"><b>import</b></span>&nbsp;StdDynamic,&nbsp;StdEnv<br>
<br>
::&nbsp;Tree&nbsp;a&nbsp;=&nbsp;Node&nbsp;a&nbsp;(Tree&nbsp;a)&nbsp;(Tree&nbsp;a)&nbsp;|&nbsp;Leaf<br>
<br>
Start&nbsp;world<br>
#&nbsp;(ok,world)&nbsp;=&nbsp;writeDynamic&nbsp;"DynTreeValue"&nbsp;MyTree&nbsp;world<br>
|&nbsp;not&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;abort&nbsp;"could&nbsp;not&nbsp;write&nbsp;MyTree&nbsp;to&nbsp;file&nbsp;named&nbsp;DynTreeValue"<br>
|&nbsp;<span style="font-family:courier;color:#FF0000;"><b>otherwise</b></span>&nbsp;&nbsp;=&nbsp;world<br>
<span style="font-family:courier;color:#FF0000;"><b>where</b></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;MyTree::Dynamic<br>
&nbsp;&nbsp;&nbsp;&nbsp;MyTree&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;(Node&nbsp;1&nbsp;mytree&nbsp;mytree)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:courier;color:#FF0000;"><b>where</b></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mytree&nbsp;=&nbsp;(Node&nbsp;2&nbsp;(Node&nbsp;3&nbsp;Leaf&nbsp;Leaf)&nbsp;Leaf)<br></div>
<p></p><p></p><div style="background-color:#FFFF45;">Example of another CLEAN application writing a <span style="font-family:courier;">Dynamic</span> containing the function countleafs to a File named CountsLeafsinTrees. This function can count the numbers of leafs in a <span style="font-family:courier;">Tree</span> and is of type <span style="font-family:courier;">(Tree Int) -&gt; Int</span>. This examples shows that code (in this case the function <span style="font-family:courier;">CountLeafs</span>) can be stored on disk as well, just using <span style="font-family:courier;">WriteDynamic</span>.</div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
<span style="font-family:courier;color:#FF0000;"><b>module</b></span>&nbsp;CountLeafs<br>
<br>
<span style="font-family:courier;color:#FF0000;"><b>import</b></span>&nbsp;StdDynamic,&nbsp;StdEnv<br>
<br>
::&nbsp;Tree&nbsp;a&nbsp;=&nbsp;Node&nbsp;a&nbsp;(Tree&nbsp;a)&nbsp;(Tree&nbsp;a)&nbsp;|&nbsp;Leaf<br>
<br>
Start&nbsp;world<br>
#&nbsp;(ok,world)&nbsp;=&nbsp;writeDynamic&nbsp;"CountsLeafsinTrees"&nbsp;CountLeafs&nbsp;world<br>
|&nbsp;not&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;abort&nbsp;"could&nbsp;not&nbsp;write&nbsp;dynamic"<br>
|&nbsp;<span style="font-family:courier;color:#FF0000;"><b>otherwise</b></span>&nbsp;&nbsp;=&nbsp;world<br>
<span style="font-family:courier;color:#FF0000;"><b>where</b></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;CountLeafs&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;countleafs<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;countleafs::&nbsp;(Tree&nbsp;Int)&nbsp;-&gt;&nbsp;Int<br>
&nbsp;&nbsp;&nbsp;&nbsp;countleafs&nbsp;&nbsp;tree&nbsp;=&nbsp;count&nbsp;tree&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:courier;color:#FF0000;"><b>where</b></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count::&nbsp;(Tree&nbsp;a)&nbsp;Int&nbsp;-&gt;&nbsp;Int<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;Leaf&nbsp;nleafs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;nleafs&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;(Node&nbsp;left&nbsp;right)&nbsp;nleafs&nbsp;&nbsp;=&nbsp;count&nbsp;left&nbsp;(count&nbsp;right&nbsp;nleafs)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count&nbsp;else&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;abort&nbsp;"count&nbsp;does&nbsp;not&nbsp;match"<br></div>
<p></p><p></p><div style="background-color:#FFFF45;">The third CLEAN application reads in the file TreeValue containing a <span style="font-family:courier;">Tree Int</span> and the function <span style="font-family:courier;">countleafs</span> (a plugin) that can counts the number of <span style="font-family:courier;">Leaf</span>s in a <span style="font-family:courier;">Tree</span>. So, new functionality is added to the running application Apply. By using the function <span style="font-family:courier;">dynapply</span> the new plugged in function countleafs is applied to the tree that has been read in as well. The application <span style="font-family:courier;">Apply</span> itself has a function to count the number of nodes and applies this function on the tree read in. <br>Note that this application will only work if all the type <span style="font-family:courier;">Tree</span>s defined in the different applications are exactly the same (module the names for the type variables used).<br></div>
<div style="font-family:courier;margin:0px;background-color:#FFFF99;"><br>
<span style="font-family:courier;color:#FF0000;"><b>module</b></span>&nbsp;Apply<br>
<br>
<span style="font-family:courier;color:#FF0000;"><b>import</b></span>&nbsp;StdDynamic,&nbsp;StdEnv<br>
<br>
::&nbsp;Tree&nbsp;a&nbsp;=&nbsp;Node&nbsp;a&nbsp;(Tree&nbsp;a)&nbsp;(Tree&nbsp;a)&nbsp;|&nbsp;Leaf<br>
<br>
Start&nbsp;world<br>
#&nbsp;(ok,countleafs,world)&nbsp;&nbsp;&nbsp;=&nbsp;read&nbsp;"CountsLeafsinTrees"&nbsp;world<br>
|&nbsp;not&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;abort&nbsp;("could&nbsp;not&nbsp;read&nbsp;CountsLeafsinTrees")<br>
#&nbsp;(ok,treevalue,world)&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;read&nbsp;"TreeValue"&nbsp;world<br>
|&nbsp;not&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;abort&nbsp;("could&nbsp;not&nbsp;read&nbsp;TreeValue")<br>
|&nbsp;<span style="font-family:courier;color:#FF0000;"><b>otherwise</b></span>&nbsp;&nbsp;=&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;&nbsp;&nbsp;countnodes&nbsp;(<span style="font-family:courier;color:#FF0000;"><b>case</b></span>&nbsp;treevalue&nbsp;<span style="font-family:courier;color:#FF0000;"><b>of</b></span>&nbsp;(v::(Tree&nbsp;Int))=&nbsp;v)&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;dynapply&nbsp;countleafs&nbsp;treevalue<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<span style="font-family:courier;color:#FF0000;"><b>where</b></span><br>
&nbsp;&nbsp;&nbsp;&nbsp;dynapply&nbsp;::&nbsp;Dynamic&nbsp;Dynamic&nbsp;-&gt;&nbsp;Dynamic<br>
&nbsp;&nbsp;&nbsp;&nbsp;dynapply&nbsp;(f::a&nbsp;-&gt;&nbsp;b)&nbsp;(v::a)&nbsp;&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;(f&nbsp;v)<br>
&nbsp;&nbsp;&nbsp;&nbsp;dynapply&nbsp;df&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dv&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;<span style="font-family:courier;color:#FF0000;"><b>dynamic</b></span>&nbsp;"incorrectly&nbsp;typed&nbsp;dynamic&nbsp;application"<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;countnodes&nbsp;Leaf&nbsp;nnodes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;nnodes<br>
&nbsp;&nbsp;&nbsp;&nbsp;countnodes&nbsp;(Node&nbsp;left&nbsp;right)&nbsp;nnodes&nbsp;=&nbsp;countnodes&nbsp;left&nbsp;(countnodes&nbsp;right&nbsp;(nnodes+1))<br></div>
<p></p>
<h2 style="background-color:#9999FF;"><a id="_8.4">8.4 Architecture of the implementation</a></h2>
<p style="text-align:justify;">From the examples above we learn that a <span style="font-family:courier;">Dynamic</span> stored on disk can contain data as well as code (unevaluated functions and function applications). How is this information stored into a file and how is a running CLEAN application extended with new data and new functionality? To understand this one has to know a little bit more about how a CLEAN application is generated.</p>
<h3 style="background-color:#9999FF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Implementation of Dynamics</h3>
<p style="text-align:justify;">CLEAN applications are not interpreted via an interpreter. Executables are generated using compiled machine code. Storing a <span style="font-family:courier;">Dynamic</span> into disk and retrieving it again from disk cannot simply be done by (re) interpretation of CLEAN source code.</p>
<svg width="888.888888888889" height="180">
<path d="M373.333333333333 63C373.333333333333 67.9705627482,379.224370664533 72,384 72L533.333333333333 72C539.224370664533 72,544 67.0294372518,544 63L544 42C544 37.0294372518,538.1089626688 33,533.333333333333 33L384 33C378.1089626688 33,373.333333333333 37.9705627482,373.333333333333 42L373.333333333333 63 Z" fill="#3366FF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="46.5" fill="#000000">Clean Compiler</text>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="70.5" fill="#FF0000">Clean</text>
<path d="M373.333333333333 111C373.333333333333 115.9705627482,379.224370664533 120,384 120L533.333333333333 120C539.224370664533 120,544 115.0294372518,544 111L544 90C544 85.0294372518,538.1089626688 81,533.333333333333 81L384 81C378.1089626688 81,373.333333333333 85.9705627482,373.333333333333 90L373.333333333333 111 Z" fill="#3366FF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="94.5" fill="#000000">Code Generator</text>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="118.5" fill="#FF0000">C</text>
<path d="M160 159C160 163.9705627482,165.8910373312 168,170.666666666667 168L320 168C325.8910373312 168,330.666666666667 163.0294372518,330.666666666667 159L330.666666666667 138C330.666666666667 133.0294372518,324.775629335467 129,320 129L170.666666666667 129C164.775629335467 129,160 133.9705627482,160 138L160 159 Z" fill="#3366FF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="177.777777777778" y="142.5" fill="#000000">Your Application</text>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="177.777777777778" y="166.5" fill="#FF0000">Clean</text>
<path d="M373.333333333333 159C373.333333333333 163.9705627482,379.224370664533 168,384 168L533.333333333333 168C539.224370664533 168,544 163.0294372518,544 159L544 138C544 133.0294372518,538.1089626688 129,533.333333333333 129L384 129C378.1089626688 129,373.333333333333 133.9705627482,373.333333333333 138L373.333333333333 159 Z" fill="#3366FF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="142.5" fill="#000000">Static Linker</text>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="166.5" fill="#FF0000">Clean</text>
<path d="M229.333333333333 39 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#FF9900" stroke="none"/>
<path d="M231.111111111111 34.5 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M270.222222222222 34.5 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<path d="M236.444444444444 30 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M275.555555555556 30 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="234.666666666667" y="57" fill="#000000">.icl</text>
<path d="M592 60 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#FF9900" stroke="none"/>
<path d="M593.777777777778 55.5 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M632.888888888889 55.5 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<path d="M599.111111111111 51 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M638.222222222222 51 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="597.333333333333" y="78" fill="#000000">.abc</text>
<path d="M592 108 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#FF9900" stroke="none"/>
<path d="M593.777777777778 103.5 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M632.888888888889 103.5 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<path d="M599.111111111111 99 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M638.222222222222 99 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="597.333333333333" y="126" fill="#000000">.obj</text>
<path d="M282.666666666667 39 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#99FF99" stroke="none"/>
<path d="M284.444444444444 34.5 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#99FF99" stroke="none"/>
<path d="M323.555555555556 34.5 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#99FF99" stroke="none"/>
<path d="M289.777777777778 30 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#99FF99" stroke="none"/>
<path d="M328.888888888889 30 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#99FF99" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="288" y="57" fill="#000000">.dcl</text>
<path d="M348.444444444444 144 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M348.444444444444 156L341.333333333333 148.5L348.444444444444 141 Z" fill="#FF00FF" stroke="none"/>
<path d="M341.333333333333 48 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M362.666666666667 60L369.777777777778 52.5L362.666666666667 45 Z" fill="#FF00FF" stroke="none"/>
<path d="M561.777777777778 129 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M561.777777777778 141L554.666666666667 133.5L561.777777777778 126 Z" fill="#FF00FF" stroke="none"/>
<path d="M554.666666666667 111 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M576 123L583.111111111111 115.5L576 108 Z" fill="#FF00FF" stroke="none"/>
<path d="M561.777777777778 81 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M561.777777777778 93L554.666666666667 85.5L561.777777777778 78 Z" fill="#FF00FF" stroke="none"/>
<path d="M554.666666666667 63 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M576 75L583.111111111111 67.5L576 60 Z" fill="#FF00FF" stroke="none"/>
</svg>
<p style="text-align:justify;">The CLEAN compiler (written in CLEAN) compiles CLEAN implementation modules (.icl and .dcl files) to machine independent abc-code (.abc files). The CLEAN definition modules are used to check the type consistency between the separately programmed CLEAN modules. The abc-code contains machine instructions for a virtual abstract machine, the abc-machine (see <span style="color:#0000FF;">Plasmeijer and van van Eekelen</span>, 1993). The abc-code is a kind of platform independent byte code specially designed for CLEAN. The Code Generator (the one and only application in the Clean system which is written in C) translates the abc-code into platform dependent symbolic machine code (.obj files under Windows). The code generator can generate code for different platforms such as for Intel (Windows, Linux), Motorola (Mac) and Sparc (Unix) processors. The Static Linker (written in CLEAN) links all the object modules of one CLEAN program together into a click able executable application (.exe file under Windows). The compilation scheme described above can be used even if Dynamics are internally used in an application. But, as soon as <span style="font-family:courier;">Dynamic</span>s are communicated to <span style="font-family:courier;">File</span> or communicated to another program, a different run-time support is needed and the traditional compilation scheme is changed to prepare this.</p>
<svg width="888.888888888889" height="255">
<path d="M373.333333333333 63C373.333333333333 67.9705627482,379.224370664533 72,384 72L533.333333333333 72C539.224370664533 72,544 67.0294372518,544 63L544 42C544 37.0294372518,538.1089626688 33,533.333333333333 33L384 33C378.1089626688 33,373.333333333333 37.9705627482,373.333333333333 42L373.333333333333 63 Z" fill="#3366FF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="46.5" fill="#000000">Clean Compiler</text>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="70.5" fill="#FF0000">Clean</text>
<path d="M373.333333333333 111C373.333333333333 115.9705627482,379.224370664533 120,384 120L533.333333333333 120C539.224370664533 120,544 115.0294372518,544 111L544 90C544 85.0294372518,538.1089626688 81,533.333333333333 81L384 81C378.1089626688 81,373.333333333333 85.9705627482,373.333333333333 90L373.333333333333 111 Z" fill="#3366FF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="94.5" fill="#000000">Code Generator</text>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="118.5" fill="#FF0000">C</text>
<path d="M373.333333333333 159C373.333333333333 163.9705627482,379.224370664533 168,384 168L533.333333333333 168C539.224370664533 168,544 163.0294372518,544 159L544 138C544 133.0294372518,538.1089626688 129,533.333333333333 129L384 129C378.1089626688 129,373.333333333333 133.9705627482,373.333333333333 138L373.333333333333 159 Z" fill="#3366FF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="142.5" fill="#000000">Static Linker</text>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="391.111111111111" y="166.5" fill="#FF0000">Clean</text>
<path d="M302.222222222222 234C302.222222222222 238.9705627482,308.113259553422 243,312.888888888889 243L462.222222222222 243C468.113259553422 243,472.888888888889 238.0294372518,472.888888888889 234L472.888888888889 213C472.888888888889 208.0294372518,466.997851557689 204,462.222222222222 204L312.888888888889 204C306.997851557689 204,302.222222222222 208.9705627482,302.222222222222 213L302.222222222222 234 Z" fill="#3366FF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="320" y="217.5" fill="#000000">Your Application</text>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="320" y="241.5" fill="#FF0000">Clean</text>
<path d="M480 234C480 238.9705627482,485.8910373312 243,490.666666666667 243L533.333333333333 243C539.224370664533 243,544 238.0294372518,544 234L544 213C544 208.0294372518,538.1089626688 204,533.333333333333 204L490.666666666667 204C484.775629335467 204,480 208.9705627482,480 213L480 234 Z" fill="#3366FF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="494.222222222222" y="216" fill="#000000">Plug</text>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="494.222222222222" y="240" fill="#000000">In</text>
<path d="M590.222222222222 234C590.222222222222 238.9705627482,596.113259553422 243,600.888888888889 243L750.222222222222 243C756.113259553422 243,760.888888888889 238.0294372518,760.888888888889 234L760.888888888889 213C760.888888888889 208.0294372518,754.997851557689 204,750.222222222222 204L600.888888888889 204C594.997851557689 204,590.222222222222 208.9705627482,590.222222222222 213L590.222222222222 234 Z" fill="#3366FF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="608" y="217.5" fill="#000000">Dynamic Linker</text>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="608" y="241.5" fill="#FF0000">Clean</text>
<path d="M229.333333333333 39 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#FF9900" stroke="none"/>
<path d="M231.111111111111 34.5 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M270.222222222222 34.5 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<path d="M236.444444444444 30 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M275.555555555556 30 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="234.666666666667" y="57" fill="#000000">.icl</text>
<path d="M592 60 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#FF9900" stroke="none"/>
<path d="M593.777777777778 55.5 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M632.888888888889 55.5 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<path d="M599.111111111111 51 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M638.222222222222 51 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="597.333333333333" y="78" fill="#000000">.abc</text>
<path d="M592 109.5 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#FF9900" stroke="none"/>
<path d="M593.777777777778 105 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M632.888888888889 105 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<path d="M599.111111111111 100.5 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#FF9900" stroke="none"/>
<path d="M638.222222222222 100.5 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#FF9900" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="597.333333333333" y="127.5" fill="#000000">.obj</text>
<path d="M592 147 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#FF9900" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="597.333333333333" y="165" fill="#000000">.lib</text>
<path d="M645.333333333333 147 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#FF9900" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="650.666666666667" y="165" fill="#000000">.typ</text>
<path d="M225.777777777778 207 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#99CCFF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="231.111111111111" y="225" fill="#000000">.dyn</text>
<path d="M698.666666666667 147 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#99CCFF" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="704" y="165" fill="#000000">.sysdyn</text>
<path d="M282.666666666667 39 h39.1111111111111 v33 h-39.1111111111111 Z" fill="#99FF99" stroke="none"/>
<path d="M284.444444444444 34.5 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#99FF99" stroke="none"/>
<path d="M323.555555555556 34.5 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#99FF99" stroke="none"/>
<path d="M289.777777777778 30 h42.6666666666667 v3 h-42.6666666666667 Z" fill="#99FF99" stroke="none"/>
<path d="M328.888888888889 30 h3.55555555555556 v36 h-3.55555555555556 Z" fill="#99FF99" stroke="none"/>
<text font-family="Helvetica" font-weight="bold" font-size="16px" x="288" y="57" fill="#000000">.dcl</text>
<path d="M341.333333333333 48 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M362.666666666667 60L369.777777777778 52.5L362.666666666667 45 Z" fill="#FF00FF" stroke="none"/>
<path d="M554.666666666667 159 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M576 171L583.111111111111 163.5L576 156 Z" fill="#FF00FF" stroke="none"/>
<path d="M561.777777777778 129 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M561.777777777778 141L554.666666666667 133.5L561.777777777778 126 Z" fill="#FF00FF" stroke="none"/>
<path d="M554.666666666667 111 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M576 123L583.111111111111 115.5L576 108 Z" fill="#FF00FF" stroke="none"/>
<path d="M561.777777777778 81 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M561.777777777778 93L554.666666666667 85.5L561.777777777778 78 Z" fill="#FF00FF" stroke="none"/>
<path d="M554.666666666667 63 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#FF00FF" stroke="none"/>
<path d="M576 75L583.111111111111 67.5L576 60 Z" fill="#FF00FF" stroke="none"/>
<path d="M444.444444444444 174 h10.6666666666667 v18 h-10.6666666666667 Z" fill="#FF00FF" stroke="none"/>
<path d="M458.666666666667 192L449.777777777778 198L440.888888888889 192 Z" fill="#FF00FF" stroke="none"/>
<path d="M721.777777777778 49.5 h14.2222222222222 v12 h-14.2222222222222 Z" fill="#FF00FF" stroke="none"/>
<path d="M721.777777777778 79.5 h14.2222222222222 v12 h-14.2222222222222 Z" fill="#99CCFF" stroke="none"/>
<path d="M561.777777777778 219 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#99CCFF" stroke="none"/>
<path d="M561.777777777778 231L554.666666666667 223.5L561.777777777778 216 Z" fill="#99CCFF" stroke="none"/>
<path d="M275.555555555556 228 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#99CCFF" stroke="none"/>
<path d="M275.555555555556 240L268.444444444444 232.5L275.555555555556 225 Z" fill="#99CCFF" stroke="none"/>
<path d="M268.444444444444 210 h21.3333333333333 v9 h-21.3333333333333 Z" fill="#99CCFF" stroke="none"/>
<path d="M289.777777777778 222L296.888888888889 214.5L289.777777777778 207 Z" fill="#99CCFF" stroke="none"/>
<path d="M608 180 h10.6666666666667 v18 h-10.6666666666667 Z" fill="#99CCFF" stroke="none"/>
<path d="M622.222222222222 198L613.333333333333 204L604.444444444444 198 Z" fill="#99CCFF" stroke="none"/>
<path d="M661.333333333333 180 h10.6666666666667 v18 h-10.6666666666667 Z" fill="#99CCFF" stroke="none"/>
<path d="M675.555555555556 198L666.666666666667 204L657.777777777778 198 Z" fill="#99CCFF" stroke="none"/>
<path d="M714.666666666667 186 h10.6666666666667 v18 h-10.6666666666667 Z" fill="#99CCFF" stroke="none"/>
<path d="M728.888888888889 186L720 180L711.111111111111 186 Z" fill="#99CCFF" stroke="none"/>
<path d="M711.111111111111 45 h142.222222222222 v21 h-142.222222222222 Z" fill="none" stroke="#000000"/>
<path d="M711.111111111111 75 h142.222222222222 v21 h-142.222222222222 Z" fill="none" stroke="#000000"/>
<text font-family="Helvetica" font-size="16px" x="746.666666666667" y="60" fill="#000000">Compile Time</text>
<text font-family="Helvetica" font-size="16px" x="746.666666666667" y="90" fill="#000000">Run Time</text>
</svg>
<p style="text-align:justify;">In the changed compilation scheme, the static linker not only generates an application (actually, currently it is a .bat file), but it also generates two additional files. One is called the code repository (.lib file). All object codes of your application are collected here. The other file (.typ file) is a repository that contains all type definitions. The repositories serve as a database which is accessed by the Dynamic Linker. Whenever an (other) running application needs code for a plug in or a type that has to be checked, the Dynamic Linker will look it up in the appropriate repository. Each time a CLEAN program is recompiled, new repositories are created. Repositories should not be removed by hand because it might make the <span style="font-family:courier;">Dynamic</span>s stored on disk unreadable. A special garbage collector is provided that can remove unused repositories.</p>
<p style="text-align:justify;">When a CLEAN application doing dynamic I/O is started, a special linker (the Dynamic Linker, written in CLEAN) is started with it as well (if it is not already running). The Dynamic Linker is a server application on the computer. It will serve all running CLEAN programs that read or write <span style="font-family:courier;">Dynamic</span>s. The Dynamic Linker will construct the application or plug-in at run-time in the same way as the Static Linker would do at compile-time for a conventional CLEAN program. There is no efficiency penalty once the code is linked in.</p>
<p style="text-align:justify;">When a <span style="font-family:courier;">Dynamic</span> is written to disk using the function <span style="font-family:courier;">writeDynamic</span>, two (!) files are created: a .dyn file and a .sysdyn file. The .sysdyn file contains the actual information: a String encoding of the dynamic. This sysdyn file is used by the Dynamic Linker and should not be touched by the user because it might make the <span style="font-family:courier;">Dynamic</span>s stored on disk unreadable. The special garbage collector provided will also remove unused .sysdyn files.</p>
<p style="text-align:justify;">The user may only touch and use the .dyn file that contains references to the actual dynamic stored in the .sysdyn file. The .dyn file can be seen as a "typed" file. It can be handled like any other user file. It can be renamed, moved or deleted without any danger.</p>
<p style="text-align:justify;">When a <span style="font-family:courier;">Dynamic</span>is written to a file, an encoding of the graph and its type are written to disk. The graph is encoded in such a way that sharing will be maintained when the graph is read in again. The stored graph may contain unevaluated functions. In a <span style="font-family:courier;">Dynamic</span> on disk, functions are represented by symbolic pointers to the corresponding code repositories. The types stored in a Dynamic on disk point to the corresponding type definitions stored in the type repositories.</p>
<p style="text-align:justify;"><i>No plug-in will be plugged in unless its type is approved.</i> When a <span style="font-family:courier;">Dynamic</span> stored on disk is read in by an (other) application, first only a pointer to the stored <span style="font-family:courier;">Dynamic</span>is used in the CLEAN program. To use a Dynamic in an application one first has to examine it in a pattern match. In the pattern match the type of the <span style="font-family:courier;">Dynamic</span> is unified with a specified type or with the type of another <span style="font-family:courier;">Dynamic</span>s. If the run-time type unification is successful, the Dynamic Linker will check whether all type definitions of the types involved are identical as well. This type information is fetched from the corresponding type repository when needed. If the types are identical and the conventional pattern match succeeds as well, the corresponding function body can be evaluated. Only when the evaluation of the stored Dynamic is demanded, the graph encoded in the Dynamic on disk is reconstructed as far as needed (<span style="font-family:courier;">Dynamic</span>s nested in a <span style="font-family:courier;">Dynamic</span> are reconstructed lazily). The Dynamic Linker links in the code corresponding to the unevaluated functions stored in the <span style="font-family:courier;">Dynamic</span>. It is fetched from the code repository and plugged in the running (!) application. In some cases the Dynamic Linker will ask the Code Generator to generate new code (just-in-time code generation) to construct the required image. The Dynamic Linker has to ensure that identical data types defined in different applications are linked in such a way that they are indeed considered to be of the same type at run-time.</p>
<h2 style="background-color:#9999FF;"><a id="_8.5">8.5 Semantic Restrictions on Dynamics</a></h2>
<p></p><table style="width:100%;"><tr><td style="vertical-align:top;width:30px;"><table style="border-top:7px solid white;border-bottom:1px solid white;border-left:0px solid white;border-right:8px solid white;width:16px;height:16px;background:#FFCC99;float:left"></table>
</td><td style="text-align:justify;">The following types cannot be packed/unpacked: abstract data types, uniqueness types, overloaded types. We are working on it.</td></tr>
</table>
</body>
</html>
